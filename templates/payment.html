{% extends "base.html" %}

{% block title %}支付订单 - 发财小狗饮品店{% endblock %}

{% block head %}
<!-- 微信JS-SDK -->
<script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
<!-- Canvas转换库 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- 二维码生成库 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white text-center">
                    <h4><i class="fas fa-credit-card"></i> 订单支付</h4>
                </div>
                <div class="card-body">
                    <!-- 订单信息 -->
                    <div class="order-info mb-4">
                        <h5 class="text-center mb-3">订单详情</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p><strong>订单号：</strong>{{ order.id }}</p>
                                <p><strong>下单时间：</strong>{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>客户：</strong>{{ order.customer_name or '匿名客户' }}</p>
                                <p><strong>总金额：</strong><span class="text-danger h5">¥{{ "%.2f"|format(order.total_amount) }}</span></p>
                            </div>
                        </div>

                        <!-- 商品列表 -->
                        <div class="order-items">
                            <h6 class="mb-3">商品清单</h6>
                            {% for item in order.items %}
                            <div class="item-card mb-3 p-3 border rounded">
                                <div class="row align-items-center">
                                    <div class="col-md-2">
                                        {% if item.product.image_url %}
                                        <img src="{{ item.product.image_url }}" alt="{{ item.product.name }}"
                                             class="img-fluid rounded" style="max-height: 60px;">
                                        {% else %}
                                        <div class="placeholder-img bg-light rounded d-flex align-items-center justify-content-center"
                                             style="height: 60px; width: 60px;">
                                            <i class="fas fa-coffee text-muted"></i>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="mb-1">{{ item.product.name }}</h6>
                                        <small class="text-muted">{{ item.product.category.name }}</small>
                                    </div>
                                    <div class="col-md-2">
                                        <span class="badge bg-info">{{ item.size }}</span>
                                    </div>
                                    <div class="col-md-2">
                                        <strong>x{{ item.quantity }}</strong>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <strong class="text-primary">¥{{ "%.2f"|format(item.subtotal) }}</strong>
                                    </div>
                                </div>
                                {% if item.notes %}
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-muted">
                                            <i class="fas fa-sticky-note"></i> 备注：{{ item.notes }}
                                        </small>
                                    </div>
                                </div>
                                {% endif %}
                                {% if item.sugar_level %}
                                <div class="row mt-1">
                                    <div class="col-12">
                                        <small class="text-info">
                                            <i class="fas fa-cube"></i> 糖度：{{ item.sugar_level }}
                                        </small>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <hr>

                    <!-- 支付方式 -->
                    <div class="payment-methods">
                        <h4 class="text-center mb-4 payment-title">
                            <i class="fas fa-mobile-alt text-primary"></i>
                            选择支付方式
                        </h4>

                        {% if payment_configs %}
                        <!-- 支付方式选择卡片 -->
                        <div class="payment-cards mb-4">
                            {% for config in payment_configs %}
                            <div class="payment-card {% if loop.first %}active{% endif %}"
                                 data-payment-id="{{ config.id }}"
                                 data-payment-type="{{ config.payment_type }}"
                                 role="button"
                                 tabindex="0">
                                <div class="payment-card-header">
                                    {% if config.payment_type == 'wechat' %}
                                        <div class="payment-icon wechat-icon">
                                            <i class="fab fa-weixin"></i>
                                        </div>
                                        <div class="payment-info">
                                            <h5 class="payment-name">{{ config.payment_name }}</h5>
                                            <p class="payment-desc">安全便捷的微信支付</p>
                                        </div>
                                    {% elif config.payment_type == 'alipay' %}
                                        <div class="payment-icon alipay-icon">
                                            <i class="fab fa-alipay"></i>
                                        </div>
                                        <div class="payment-info">
                                            <h5 class="payment-name">{{ config.payment_name }}</h5>
                                            <p class="payment-desc">快速安全的支付宝支付</p>
                                        </div>
                                    {% else %}
                                        <div class="payment-icon other-icon">
                                            <i class="fas fa-qrcode"></i>
                                        </div>
                                        <div class="payment-info">
                                            <h5 class="payment-name">{{ config.payment_name }}</h5>
                                            <p class="payment-desc">扫码完成支付</p>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="payment-card-check">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- 支付内容区域 -->
                        <div class="payment-content">
                            {% for config in payment_configs %}
                            <div class="payment-section {% if loop.first %}active{% endif %}"
                                 id="payment-section-{{ config.id }}">

                                <!-- 支付金额显示 -->
                                <div class="payment-amount-card mb-4">
                                    <div class="amount-label">支付金额</div>
                                    <div class="amount-value">¥{{ "%.2f"|format(order.total_amount) }}</div>
                                    <div class="amount-desc">请确认金额后扫码支付</div>
                                </div>

                                <!-- 二维码区域 -->
                                <div class="qr-code-section">
                                    <div class="qr-code-wrapper">
                                        <div class="qr-code-container">
                                            {% if config.payment_type == 'wechat' %}
                                            <!-- 简化的微信二维码显示 -->
                                            <div class="simple-qr-wrapper">
                                                <img src="{{ config.qr_code_image_url }}"
                                                     alt="{{ config.payment_name }}二维码"
                                                     class="simple-qr-image"
                                                     title="长按识别二维码"
                                                     onerror="this.src='{{ url_for('static', filename='images/placeholder_qr.svg') }}'">
                                            </div>

                                            <div class="simple-qr-tip">
                                                <i class="fab fa-weixin text-success"></i>
                                                <span>长按二维码即可支付</span>
                                            </div>
                                            {% else %}
                                            <img src="{{ config.qr_code_image_url }}"
                                                 alt="{{ config.payment_name }}二维码"
                                                 class="qr-code-image"
                                                 style="width: 250px; height: 250px;"
                                                 onerror="this.src='{{ url_for('static', filename='images/placeholder_qr.svg') }}'">
                                            {% endif %}
                                        </div>

                                        {% if config.account_name %}
                                        <div class="account-info">
                                            <p class="account-name">{{ config.account_name }}</p>
                                            {% if config.account_info %}
                                            <p class="account-desc">{{ config.account_info }}</p>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- 支付步骤 -->
                                    <div class="payment-steps">
                                        <h6 class="steps-title">
                                            <i class="fas fa-list-ol"></i> 支付步骤
                                        </h6>
                                        <div class="steps-content">
                                            {% if config.payment_type == 'wechat' %}
                                            <div class="step-item">
                                                <span class="step-number">1</span>
                                                <span class="step-text">长按上方二维码</span>
                                            </div>
                                            <div class="step-item">
                                                <span class="step-number">2</span>
                                                <span class="step-text">选择"识别图中二维码"</span>
                                            </div>
                                            <div class="step-item">
                                                <span class="step-number">3</span>
                                                <span class="step-text">确认支付金额并完成支付</span>
                                            </div>
                                            {% elif config.payment_type == 'alipay' %}
                                            <div class="step-item">
                                                <span class="step-number">1</span>
                                                <span class="step-text">打开支付宝APP</span>
                                            </div>
                                            <div class="step-item">
                                                <span class="step-number">2</span>
                                                <span class="step-text">点击首页"扫一扫"</span>
                                            </div>
                                            {% else %}
                                            <div class="step-item">
                                                <span class="step-number">1</span>
                                                <span class="step-text">打开对应支付APP</span>
                                            </div>
                                            <div class="step-item">
                                                <span class="step-number">2</span>
                                                <span class="step-text">使用扫码功能</span>
                                            </div>
                                            {% endif %}
                                            <div class="step-item">
                                                <span class="step-number">{{ 3 if config.payment_type in ['wechat'] else 3 if config.payment_type == 'alipay' else 3 }}</span>
                                                <span class="step-text">扫描上方二维码</span>
                                            </div>
                                            <div class="step-item">
                                                <span class="step-number">{{ 4 if config.payment_type in ['wechat'] else 4 if config.payment_type == 'alipay' else 4 }}</span>
                                                <span class="step-text">确认支付金额并完成支付</span>
                                            </div>
                                        </div>

                                        <div class="payment-tip">
                                            {% if config.payment_type == 'wechat' %}
                                            <i class="fab fa-weixin text-success"></i>
                                            <span><strong>提示：</strong>在微信中长按二维码即可直接支付</span>
                                            {% else %}
                                            <i class="fas fa-mobile-alt text-success"></i>
                                            <span>提示：请使用对应APP扫描二维码完成支付</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        {% else %}
                        <!-- 没有配置支付方式时的提示 -->
                        <div class="text-center">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                暂未配置支付方式，请联系商家
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <hr>

                    <!-- 支付状态和操作按钮 -->
                    <div class="payment-actions text-center">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            支付完成后，请点击下方按钮确认支付状态
                        </div>
                        
                        <div class="btn-group-vertical d-grid gap-2">
                            <button type="button" class="btn btn-success btn-lg" onclick="confirmPayment()">
                                <i class="fas fa-check-circle"></i> 我已完成支付
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="checkPaymentStatus()">
                                <i class="fas fa-sync-alt"></i> 检查支付状态
                            </button>
                            <a href="{{ url_for('main.order_detail', order_id=order.id) }}" class="btn btn-outline-primary">
                                <i class="fas fa-eye"></i> 查看订单详情
                            </a>
                        </div>
                    </div>

                    <!-- 支付倒计时 -->
                    <div class="payment-timer text-center mt-3">
                        <small class="text-muted">
                            <i class="fas fa-clock"></i> 
                            请在 <span id="countdown" class="text-warning">15:00</span> 内完成支付
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 支付确认模态框 -->
<div class="modal fade" id="paymentConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认支付</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>请确认您已经完成了支付：</p>
                <ul>
                    <li>支付金额：<strong class="text-danger">¥{{ "%.2f"|format(order.total_amount) }}</strong></li>
                    <li>订单号：<strong>{{ order.id }}</strong></li>
                </ul>
                <p class="text-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    请确保支付成功后再点击确认，虚假确认可能导致订单被取消。
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="submitPaymentConfirmation()">
                    确认已支付
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 微信二维码放大模态框 -->
<div class="modal fade" id="wechatQRModal" tabindex="-1" aria-labelledby="wechatQRModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="wechatQRModalLabel">
                    <i class="fab fa-weixin text-success"></i>
                    微信扫码支付
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body text-center">
                <div class="wechat-qr-large-container">
                    <img id="wechatQRLargeImage" src="" alt="微信支付二维码" class="wechat-qr-large">
                </div>
                <div class="mt-3">
                    <h6 class="text-success">
                        <i class="fas fa-mobile-alt"></i>
                        请使用微信扫一扫功能
                    </h6>
                    <p class="text-muted mb-0">
                        打开微信 → 点击右上角"+" → 选择"扫一扫" → 扫描上方二维码
                    </p>
                </div>
                <div class="payment-amount-display mt-3">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>支付金额：¥{{ "%.2f"|format(order.total_amount) }}</strong>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> 关闭
                </button>
                <button type="button" class="btn btn-success" onclick="confirmPayment()">
                    <i class="fas fa-check"></i> 我已完成支付
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.payment-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
}

.order-info {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 25px;
    border: 1px solid #e9ecef;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.payment-title {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 30px;
}

/* 支付方式卡片 */
.payment-cards {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 30px;
}

.payment-card {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 15px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: space-between;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
}

.payment-card:hover {
    border-color: #007bff;
    box-shadow: 0 4px 15px rgba(0,123,255,0.1);
    transform: translateY(-2px);
}

.payment-card.active {
    border-color: #28a745;
    background: linear-gradient(135deg, #f8fff9, #e8f5e8);
    box-shadow: 0 4px 20px rgba(40,167,69,0.25);
    transform: translateY(-2px);
}

.payment-card:active {
    transform: translateY(0px) scale(0.98);
}

.payment-card-header {
    display: flex;
    align-items: center;
    flex: 1;
}

.payment-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-size: 24px;
}

.wechat-icon {
    background: linear-gradient(135deg, #07c160, #00d4aa);
    color: white;
}

.alipay-icon {
    background: linear-gradient(135deg, #1677ff, #00b4d8);
    color: white;
}

.other-icon {
    background: linear-gradient(135deg, #6c757d, #495057);
    color: white;
}

.payment-info h5 {
    margin: 0 0 5px 0;
    font-size: 18px;
    font-weight: 600;
    color: #2c3e50;
}

.payment-info .payment-desc {
    margin: 0;
    color: #6c757d;
    font-size: 14px;
}

.payment-card-check {
    color: #28a745;
    font-size: 24px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.payment-card.active .payment-card-check {
    opacity: 1;
}

/* 支付内容区域 */
.payment-content {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.payment-section {
    display: none;
    padding: 30px;
}

.payment-section.active {
    display: block;
}

/* 支付金额卡片 */
.payment-amount-card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    text-align: center;
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 30px;
}

.amount-label {
    font-size: 16px;
    opacity: 0.9;
    margin-bottom: 10px;
}

.amount-value {
    font-size: 36px;
    font-weight: bold;
    margin-bottom: 8px;
}

.amount-desc {
    font-size: 14px;
    opacity: 0.8;
}

/* 二维码区域 */
.qr-code-section {
    text-align: center;
}

.qr-code-wrapper {
    margin-bottom: 30px;
}

.qr-code-container {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    display: inline-block;
    margin-bottom: 20px;
}

.qr-code-image {
    max-width: 250px;
    height: auto;
    border-radius: 10px;
}

.account-info {
    margin-top: 15px;
}

.account-name {
    font-size: 18px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 5px;
}

.account-desc {
    color: #6c757d;
    font-size: 14px;
    margin: 0;
}

/* 支付步骤 */
.payment-steps {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 25px;
    text-align: left;
    max-width: 400px;
    margin: 0 auto;
}

.steps-title {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 20px;
    text-align: center;
}

.steps-content {
    margin-bottom: 20px;
}

.step-item {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    padding: 8px 0;
}

.step-number {
    background: #007bff;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    margin-right: 12px;
    flex-shrink: 0;
}

.step-text {
    color: #2c3e50;
    font-size: 14px;
}

.payment-tip {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    color: #856404;
    font-size: 13px;
}

.payment-tip i {
    margin-right: 8px;
}

/* 倒计时 */
.countdown-timer {
    background: linear-gradient(135deg, #ff6b6b, #ee5a24);
    color: white;
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    margin-bottom: 25px;
    box-shadow: 0 4px 20px rgba(255, 107, 107, 0.3);
}

.countdown-timer h5 {
    margin: 0 0 10px 0;
    font-weight: 600;
}

.countdown-timer #countdown {
    font-size: 28px;
    font-weight: bold;
    font-family: 'Courier New', monospace;
}

/* 确认支付按钮 */
.btn-confirm-payment {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
    padding: 15px 40px;
    font-size: 18px;
    font-weight: 600;
    border-radius: 30px;
    box-shadow: 0 4px 20px rgba(40, 167, 69, 0.3);
    transition: all 0.3s ease;
    width: 100%;
    margin-top: 20px;
}

.btn-confirm-payment:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(40, 167, 69, 0.4);
}

/* 响应式设计 */
@media (max-width: 768px) {
    .payment-container {
        padding: 15px;
    }

    .payment-card {
        padding: 15px;
    }

    .payment-icon {
        width: 40px;
        height: 40px;
        font-size: 20px;
        margin-right: 12px;
    }

    .payment-info h5 {
        font-size: 16px;
    }

    .qr-code-image {
        max-width: 200px;
    }

    .amount-value {
        font-size: 28px;
    }

    .payment-section {
        padding: 20px;
    }

    .payment-steps {
        padding: 20px;
    }
}

/* 动画效果 */
.payment-alert {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    min-width: 300px;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

/* 点击波纹效果 */
.payment-card {
    position: relative;
    overflow: hidden;
}

.ripple {
    position: absolute;
    border-radius: 50%;
    background: rgba(0, 123, 255, 0.3);
    transform: scale(0);
    animation: ripple-animation 0.6s linear;
    pointer-events: none;
}

@keyframes ripple-animation {
    to {
        transform: scale(4);
        opacity: 0;
    }
}

/* 加载动画 */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* 支付成功动画 */
.payment-success {
    animation: bounce 0.6s ease-in-out;
}

@keyframes bounce {
    0%, 20%, 60%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-10px);
    }
    80% {
        transform: translateY(-5px);
    }
}

/* 简化的微信二维码样式 */
.simple-qr-wrapper {
    text-align: center;
    margin: 20px 0;
}

.simple-qr-image {
    width: 250px;
    height: 250px;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(7, 193, 96, 0.2);
    transition: all 0.3s ease;
    cursor: pointer;
    /* 关键：允许长按识别 */
    -webkit-touch-callout: default;
    -webkit-user-select: none;
    user-select: none;
}

.simple-qr-image:hover {
    transform: scale(1.02);
    box-shadow: 0 12px 35px rgba(7, 193, 96, 0.3);
}

.simple-qr-tip {
    text-align: center;
    margin-top: 15px;
    padding: 10px;
    background: #f8fff9;
    border-radius: 10px;
    color: #28a745;
    font-weight: 500;
}

.simple-qr-tip i {
    margin-right: 8px;
    font-size: 18px;
}

/* 简化的样式保留 */

/* 简化的支付提示样式 */
.payment-tip {
    text-align: center;
    padding: 12px;
    background: #f8fff9;
    border-radius: 10px;
    margin: 15px 0;
}

.payment-tip i {
    margin-right: 8px;
}

/* 清理完成 */

.qr-zoom-hint {
    position: absolute;
    bottom: -35px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #07c160, #00d4aa);
    color: white;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 12px;
    opacity: 0;
    transition: all 0.3s ease;
    white-space: nowrap;
    box-shadow: 0 4px 15px rgba(7, 193, 96, 0.3);
    z-index: 10;
}

.qr-code-container:hover .qr-zoom-hint {
    opacity: 1;
    transform: translateX(-50%) translateY(-5px);
}

.qr-zoom-hint i {
    margin-right: 5px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* 长按提示动画 */
.long-press-hint {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(7, 193, 96, 0.9);
    color: white;
    padding: 6px 10px;
    border-radius: 12px;
    font-size: 11px;
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 10;
    pointer-events: none;
    white-space: nowrap;
    box-shadow: 0 2px 8px rgba(7, 193, 96, 0.3);
}

.qrcodeWrap:hover .long-press-hint {
    opacity: 1;
    transform: translateY(-2px);
}

/* 微信二维码放大模态框样式 */
.wechat-qr-large-container {
    background: white;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    display: inline-block;
    border: 3px solid #07c160;
}

.wechat-qr-large {
    max-width: 400px;
    width: 100%;
    height: auto;
    border-radius: 15px;
}

.payment-amount-display .alert {
    border-radius: 15px;
    border: none;
    font-size: 16px;
    font-weight: 600;
}

/* 微信模态框标题样式 */
#wechatQRModal .modal-header {
    background: linear-gradient(135deg, #07c160, #00d4aa);
    color: white;
    border-radius: 15px 15px 0 0;
}

#wechatQRModal .modal-header .btn-close {
    filter: invert(1);
}

#wechatQRModal .modal-content {
    border-radius: 15px;
    border: none;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
}

#wechatQRModal .modal-body {
    padding: 30px;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .wechat-qr-large {
        max-width: 280px;
    }

    .wechat-qr-large-container {
        padding: 20px;
    }

    #wechatQRModal .modal-body {
        padding: 20px;
    }
}
</style>

<script>
// 支付方式切换
function selectPayment(paymentId) {
    console.log('=== 开始切换支付方式 ===');
    console.log('目标支付方式ID:', paymentId);
    console.log('参数类型:', typeof paymentId);

    // 确保paymentId是字符串
    paymentId = String(paymentId);

    try {
        // 查找所有元素
        const allCards = document.querySelectorAll('.payment-card');
        const allSections = document.querySelectorAll('.payment-section');

        console.log('找到支付卡片数量:', allCards.length);
        console.log('找到支付区域数量:', allSections.length);

        // 打印所有卡片的ID
        allCards.forEach((card, index) => {
            const cardId = card.getAttribute('data-payment-id');
            console.log(`卡片${index + 1}: ID=${cardId}, 类型=${typeof cardId}`);
        });

        // 打印所有区域的ID
        allSections.forEach((section, index) => {
            const sectionId = section.id;
            console.log(`区域${index + 1}: ID=${sectionId}`);
        });

        // 移除所有活动状态
        console.log('移除所有活动状态...');
        allCards.forEach(card => {
            card.classList.remove('active');
            console.log('移除卡片active:', card.getAttribute('data-payment-id'));
        });
        allSections.forEach(section => {
            section.classList.remove('active');
            console.log('移除区域active:', section.id);
        });

        // 查找目标元素
        console.log('查找目标元素...');
        const selectedCard = document.querySelector(`[data-payment-id="${paymentId}"]`);
        const selectedSection = document.getElementById(`payment-section-${paymentId}`);

        console.log('选中的卡片:', selectedCard);
        console.log('选中的区域:', selectedSection);

        // 激活选中的支付方式
        if (selectedCard) {
            selectedCard.classList.add('active');
            console.log('✅ 成功激活支付卡片:', paymentId);

            // 添加选择动画效果
            selectedCard.style.transform = 'scale(1.02)';
            setTimeout(() => {
                selectedCard.style.transform = '';
            }, 200);
        } else {
            console.error('❌ 未找到支付卡片:', paymentId);
            // 尝试其他选择器
            const altCard = document.querySelector(`.payment-card[data-payment-id="${paymentId}"]`);
            console.log('备用选择器结果:', altCard);
        }

        if (selectedSection) {
            selectedSection.classList.add('active');
            console.log('✅ 成功激活支付区域:', paymentId);
        } else {
            console.error('❌ 未找到支付区域:', paymentId);
            // 尝试其他选择器
            const altSection = document.querySelector(`#payment-section-${paymentId}`);
            console.log('备用选择器结果:', altSection);
        }

        console.log('=== 切换完成 ===');

    } catch (error) {
        console.error('❌ 切换支付方式时出错:', error);
        console.error('错误堆栈:', error.stack);
    }
}

// 支付倒计时
let timeLeft = 15 * 60; // 15分钟
const countdownElement = document.getElementById('countdown');

function updateCountdown() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

    if (timeLeft <= 0) {
        showPaymentAlert('支付时间已过期，请重新下单', 'error');
        setTimeout(() => {
            window.location.href = '{{ url_for("main.index") }}';
        }, 2000);
        return;
    }

    timeLeft--;
}

// 每秒更新倒计时
setInterval(updateCountdown, 1000);

// 确认支付
function confirmPayment() {
    const modal = new bootstrap.Modal(document.getElementById('paymentConfirmModal'));
    modal.show();
}

// 显示支付提示
function showPaymentAlert(message, type = 'info') {
    const alertClass = type === 'error' ? 'alert-danger' : type === 'success' ? 'alert-success' : 'alert-info';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show payment-alert" role="alert">
            <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

    // 在页面顶部显示提示
    const container = document.querySelector('.payment-container');
    container.insertAdjacentHTML('afterbegin', alertHtml);

    // 3秒后自动消失
    setTimeout(() => {
        const alert = document.querySelector('.payment-alert');
        if (alert) {
            alert.remove();
        }
    }, 3000);
}

// 提交支付确认
function submitPaymentConfirmation() {
    const submitBtn = document.querySelector('button[onclick="submitPaymentConfirmation()"]');
    const originalText = submitBtn.innerHTML;

    // 显示加载状态
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 确认中...';
    submitBtn.disabled = true;

    fetch('{{ url_for("main.confirm_payment", order_id=order.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            'confirmed': true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showPaymentAlert('支付确认成功！订单已提交处理。', 'success');
            setTimeout(() => {
                window.location.href = '{{ url_for("main.order_detail", order_id=order.id) }}';
            }, 1500);
        } else {
            showPaymentAlert('确认失败：' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showPaymentAlert('网络错误，请重试', 'error');
    })
    .finally(() => {
        // 恢复按钮状态
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;

        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('paymentConfirmModal'));
        if (modal) {
            modal.hide();
        }
    });
}

// 检查支付状态
function checkPaymentStatus() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 检查中...';
    btn.disabled = true;

    fetch('{{ url_for("main.check_payment_status", order_id=order.id) }}', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.paid) {
                showPaymentAlert('支付成功！正在跳转...', 'success');
                setTimeout(() => {
                    window.location.href = '{{ url_for("main.order_detail", order_id=order.id) }}';
                }, 1500);
            } else {
                showPaymentAlert('暂未检测到支付，请确认支付后再试', 'info');
            }
        } else {
            showPaymentAlert('检查失败：' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showPaymentAlert('网络错误，请重试', 'error');
    })
    .finally(() => {
        // 恢复按钮状态
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// 初始化微信JS-SDK
function initWechatJSSDK() {
    if (isWechatBrowser()) {
        console.log('初始化微信JS-SDK');

        // 这里应该从后端获取微信配置信息
        // 为了演示，我们使用基本配置
        if (typeof wx !== 'undefined') {
            wx.config({
                debug: false, // 开启调试模式
                appId: '', // 必填，公众号的唯一标识
                timestamp: '', // 必填，生成签名的时间戳
                nonceStr: '', // 必填，生成签名的随机串
                signature: '', // 必填，签名
                jsApiList: ['previewImage'] // 必填，需要使用的JS接口列表
            });

            wx.ready(function() {
                console.log('微信JS-SDK初始化成功');
            });

            wx.error(function(res) {
                console.error('微信JS-SDK初始化失败:', res);
            });
        }
    }
}

// 添加长按事件监听
function addLongPressListener(element, callback) {
    let pressTimer = null;
    let startTime = 0;

    // 触摸开始
    element.addEventListener('touchstart', function(e) {
        startTime = Date.now();
        pressTimer = setTimeout(function() {
            callback(e);
        }, 500); // 500ms长按
    });

    // 触摸结束
    element.addEventListener('touchend', function(e) {
        if (pressTimer) {
            clearTimeout(pressTimer);
            pressTimer = null;
        }

        // 如果是短按（小于500ms），执行点击事件
        if (Date.now() - startTime < 500) {
            // 短按时的处理
            console.log('短按事件');
        }
    });

    // 触摸移动时取消长按
    element.addEventListener('touchmove', function(e) {
        if (pressTimer) {
            clearTimeout(pressTimer);
            pressTimer = null;
        }
    });
}

// 页面加载完成后的初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== 页面初始化开始 ===');

    // 初始化微信JS-SDK
    initWechatJSSDK();

    // 检查页面元素
    const allCards = document.querySelectorAll('.payment-card');
    const allSections = document.querySelectorAll('.payment-section');

    console.log('页面加载时找到的元素:');
    console.log('- 支付卡片数量:', allCards.length);
    console.log('- 支付区域数量:', allSections.length);

    // 打印所有卡片信息
    allCards.forEach((card, index) => {
        const paymentId = card.getAttribute('data-payment-id');
        const paymentType = card.getAttribute('data-payment-type');
        console.log(`卡片${index + 1}: ID=${paymentId}, 类型=${paymentType}`);
    });

    // 绑定支付方式卡片点击事件
    console.log('开始绑定点击事件...');
    allCards.forEach((card, index) => {
        const paymentId = card.getAttribute('data-payment-id');
        const paymentType = card.getAttribute('data-payment-type');

        console.log(`绑定第${index + 1}个卡片事件: ID=${paymentId}, 类型=${paymentType}`);

        card.addEventListener('click', function(event) {
            console.log('=== 卡片点击事件触发 ===');
            console.log('点击的卡片:', this);
            console.log('支付方式ID:', paymentId);
            console.log('支付方式类型:', paymentType);
            console.log('事件对象:', event);

            // 阻止事件冒泡
            event.preventDefault();
            event.stopPropagation();

            // 切换支付方式
            selectPayment(paymentId);

            // 添加点击波纹效果
            addRippleEffect(this);
        });

        // 添加键盘支持
        card.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                console.log('键盘事件触发:', e.key);
                e.preventDefault();
                this.click();
            }
        });

        // 添加鼠标悬停效果
        card.addEventListener('mouseenter', function() {
            console.log('鼠标悬停:', paymentId);
        });
    });

    console.log('事件绑定完成');

    // 为简化的微信二维码添加基本事件监听
    console.log('为微信二维码添加基本事件监听...');

    const simpleQRImages = document.querySelectorAll('.simple-qr-image');
    simpleQRImages.forEach((img, index) => {
        console.log(`为第${index + 1}个微信二维码添加事件监听`);

        // 添加长按事件
        addLongPressListener(img, function(e) {
            console.log('微信二维码长按事件触发');
            if (isWechatBrowser()) {
                console.log('微信环境中的长按，系统会自动显示识别菜单');
            } else {
                showPaymentAlert('请在微信中打开此页面进行支付', 'info');
            }
        });

        // 添加点击事件
        img.addEventListener('click', function(e) {
            if (isWechatBrowser() && typeof wx !== 'undefined' && wx.previewImage) {
                wx.previewImage({
                    current: img.src,
                    urls: [img.src]
                });
            } else {
                showPaymentAlert('请在微信中打开此页面进行支付', 'info');
            }
        });
    });

    // 简化的事件监听完成
    console.log('简化的微信支付事件监听完成');

    // 初始化第一个支付方式为选中状态
    console.log('初始化第一个支付方式...');
    const firstPaymentCard = document.querySelector('.payment-card');
    if (firstPaymentCard) {
        const paymentId = firstPaymentCard.getAttribute('data-payment-id');
        console.log('第一个支付方式ID:', paymentId);
        selectPayment(paymentId);
    } else {
        console.error('未找到任何支付卡片');
    }

    // 添加全局键盘支持
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            console.log('ESC键按下');
            const modal = bootstrap.Modal.getInstance(document.getElementById('paymentConfirmModal'));
            if (modal) {
                modal.hide();
            }
        }
    });

    console.log('=== 页面初始化完成 ===');
});

// 添加波纹效果函数
function addRippleEffect(element) {
    const ripple = document.createElement('div');
    ripple.classList.add('ripple');

    // 计算点击位置
    const rect = element.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = rect.width / 2 - size / 2;
    const y = rect.height / 2 - size / 2;

    ripple.style.width = ripple.style.height = size + 'px';
    ripple.style.left = x + 'px';
    ripple.style.top = y + 'px';

    element.appendChild(ripple);

    setTimeout(() => {
        if (ripple.parentNode) {
            ripple.remove();
        }
    }, 600);
}

// 检测是否在微信环境中
function isWechatBrowser() {
    const ua = navigator.userAgent.toLowerCase();
    return ua.indexOf('micromessenger') !== -1;
}

// 简化的微信支付处理

// 简化的微信扫一扫引导（保留基本功能）

// 简化的微信支付引导
function openWechatScan() {
    console.log('显示微信支付引导');

    if (isWechatBrowser()) {
        showPaymentAlert('请直接长按上方二维码进行支付', 'info');
    } else {
        showPaymentAlert('请在微信中打开此页面进行支付', 'info');
    }
}

// 处理微信二维码点击事件
function handleWechatQRClick(imageUrl, paymentName) {
    console.log('处理微信二维码点击:', imageUrl, paymentName);

    // 检测是否在微信环境中
    if (isWechatBrowser()) {
        console.log('检测到微信环境，尝试调用wx.previewImage');

        // 在微信环境中使用wx.previewImage
        if (typeof wx !== 'undefined' && wx.previewImage) {
            try {
                wx.previewImage({
                    current: imageUrl,
                    urls: [imageUrl],
                    success: function(res) {
                        console.log('wx.previewImage调用成功:', res);
                    },
                    fail: function(err) {
                        console.error('wx.previewImage调用失败:', err);
                        // 失败时回退到模态框
                        openWechatQRModal(imageUrl, paymentName);
                    }
                });
                return;
            } catch (error) {
                console.error('wx.previewImage调用异常:', error);
            }
        } else {
            console.log('wx对象或previewImage方法不可用，回退到模态框');
        }
    } else {
        console.log('非微信环境，使用模态框');
    }

    // 非微信环境或微信API不可用时，使用模态框
    openWechatQRModal(imageUrl, paymentName);
}

// 打开微信二维码放大模态框
function openWechatQRModal(imageUrl, paymentName) {
    console.log('打开微信二维码放大模态框:', imageUrl, paymentName);

    try {
        // 设置模态框中的图片
        const largeImage = document.getElementById('wechatQRLargeImage');
        if (largeImage) {
            largeImage.src = imageUrl;
            largeImage.alt = paymentName + '二维码';
            console.log('设置大图片URL:', imageUrl);
        } else {
            console.error('未找到大图片元素');
        }

        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('wechatQRModal'));
        modal.show();

        console.log('微信二维码模态框已显示');

        // 添加显示动画
        setTimeout(() => {
            const container = document.querySelector('.wechat-qr-large-container');
            if (container) {
                container.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    container.style.transform = 'scale(1)';
                }, 200);
            }
        }, 300);

    } catch (error) {
        console.error('打开微信二维码模态框时出错:', error);
        alert('无法打开二维码放大视图，请重试');
    }
}

// 关闭微信二维码模态框时的处理
document.addEventListener('DOMContentLoaded', function() {
    const wechatModal = document.getElementById('wechatQRModal');
    if (wechatModal) {
        wechatModal.addEventListener('hidden.bs.modal', function() {
            console.log('微信二维码模态框已关闭');
        });

        wechatModal.addEventListener('shown.bs.modal', function() {
            console.log('微信二维码模态框已完全显示');

            // 添加键盘支持
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = bootstrap.Modal.getInstance(wechatModal);
                    if (modal) {
                        modal.hide();
                    }
                }
            });
        });
    }
});
</script>
{% endblock %}
