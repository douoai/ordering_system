{% extends "admin/base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">订单详情 #{{ order.id }}</h1>
    <div>
        <a href="{{ url_for('admin.orders') }}" class="btn btn-secondary">返回订单列表</a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">订单信息</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>订单号:</strong></div>
                    <div class="col-sm-9">#{{ order.id }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>用户:</strong></div>
                    <div class="col-sm-9">{{ order.user.username }} ({{ order.user.email }})</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>状态:</strong></div>
                    <div class="col-sm-9">
                        {% if order.status == 'pending' %}
                            <span class="badge bg-warning fs-6 px-3 py-2">待确认</span>
                        {% elif order.status == 'confirmed' %}
                            <span class="badge bg-success fs-6 px-3 py-2">已确认</span>
                        {% elif order.status == 'paid' %}
                            <span class="badge bg-primary fs-6 px-3 py-2">已支付</span>
                        {% elif order.status == 'rejected' %}
                            <span class="badge bg-danger fs-6 px-3 py-2">已拒绝</span>
                        {% elif order.status == 'completed' %}
                            <span class="badge bg-success fs-6 px-3 py-2">已完成</span>
                        {% elif order.status == 'refunded' %}
                            <span class="badge bg-info fs-6 px-3 py-2">已退款</span>
                        {% else %}
                            <span class="badge bg-secondary fs-6 px-3 py-2">{{ order.status }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>下单时间:</strong></div>
                    <div class="col-sm-9">{{ order.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                </div>
                {% if order.confirmed_at %}
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>处理时间:</strong></div>
                    <div class="col-sm-9">{{ order.confirmed_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>处理人:</strong></div>
                    <div class="col-sm-9">{{ order.confirmed_by }}</div>
                </div>
                {% endif %}
                {% if order.notes %}
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>备注:</strong></div>
                    <div class="col-sm-9">{{ order.notes }}</div>
                </div>
                {% endif %}
                {% if order.refund_reason %}
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>退款原因:</strong></div>
                    <div class="col-sm-9">{{ order.refund_reason }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>退款时间:</strong></div>
                    <div class="col-sm-9">{{ order.refunded_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">订单项目</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>饮品产品</th>
                                <th>温度</th>
                                <th>单价</th>
                                <th>数量</th>
                                <th>小计</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order.order_items %}
                            <tr>
                                <td>
                                    {{ item.drink_product.name }}
                                    {% if item.notes %}
                                    <br><small class="text-muted">{{ item.notes }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.temperature %}
                                        {% if item.temperature == 'hot' %}热
                                        {% elif item.temperature == 'ice' %}冰
                                        {% elif item.temperature == 'room' %}常温
                                        {% else %}{{ item.temperature }}
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>¥{{ "%.2f"|format(item.unit_price) }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>¥{{ "%.2f"|format(item.subtotal) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-active">
                                <th colspan="3">总计</th>
                                <th>¥{{ "%.2f"|format(order.total_amount) }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        {% if order.status == 'pending' %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">订单操作</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('admin.confirm_order', order_id=order.id) }}" class="mb-2" id="confirmForm">
                    <!-- 自动打印选择 -->
                    <div class="card mb-3" style="border: 2px solid #28a745; border-radius: 10px;">
                        <div class="card-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                            <h6 class="mb-0"><i class="fas fa-print"></i> 打印设置</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="autoPrint" name="auto_print" checked>
                                <label class="form-check-label" for="autoPrint">
                                    <strong>启用自动打印</strong>
                                    <small class="text-muted d-block">确认订单后自动发送到打印机</small>
                                </label>
                            </div>

                            <div id="printerSelection">
                                <label for="printerSelect" class="form-label">选择打印机:</label>
                                <select class="form-select" id="printerSelect" name="printer_id">
                                    <option value="">默认打印机</option>
                                    {% for printer in available_printers %}
                                    <option value="{{ printer.id }}" {% if printer.auto_print_orders %}selected{% endif %}>
                                        {{ printer.name }}
                                        {% if printer.ip_address %}({{ printer.ip_address }}){% endif %}
                                        {% if not printer.is_active %}<span class="text-muted">[已禁用]</span>{% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">选择要发送订单的打印机</small>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success w-100" id="confirmBtn">
                        <i class="fas fa-check"></i> 确认订单
                    </button>
                </form>
                <form method="POST" action="{{ url_for('admin.reject_order', order_id=order.id) }}" class="mb-3">
                    <button type="submit" class="btn btn-danger w-100"
                            onclick="return confirm('确认要拒绝这个订单吗？')">
                        <i class="fas fa-times"></i> 拒绝订单
                    </button>
                </form>

                <!-- 打印按钮 -->
                <div class="d-grid gap-2">
                    <!-- 预览打印 -->
                    <a href="{{ url_for('admin.print_order', order_id=order.id) }}"
                       class="btn btn-outline-primary" target="_blank">
                        <i class="fas fa-eye"></i> 预览订单
                    </a>
                    <a href="{{ url_for('admin.print_kitchen_ticket', order_id=order.id) }}"
                       class="btn btn-outline-warning" target="_blank">
                        <i class="fas fa-eye"></i> 预览制作小票
                    </a>

                    <!-- 直接打印 -->
                    <a href="{{ url_for('admin.api_print_kitchen_ticket', order_id=order.id) }}"
                       class="btn btn-warning" onclick="return confirm('确认打印制作小票？')">
                        <i class="fas fa-print"></i> 打印制作小票
                    </a>
                    <a href="{{ url_for('admin.api_print_receipt', order_id=order.id) }}"
                       class="btn btn-success" onclick="return confirm('确认打印收据？')">
                        <i class="fas fa-receipt"></i> 打印收据
                    </a>
                    <a href="{{ url_for('admin.api_print_order', order_id=order.id) }}"
                       class="btn btn-primary" onclick="return confirm('确认打印订单详情？')">
                        <i class="fas fa-print"></i> 打印订单详情
                    </a>
                </div>
            </div>
        </div>
        {% elif order.status == 'refunded' %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">退款信息</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    该订单已被用户申请退款
                </div>
            </div>
        </div>
        {% elif order.status == 'cancel_pending' %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">取消申请审批</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    用户申请取消此订单，需要管理员审批
                </div>

                {% if order.cancel_reason %}
                <div class="mb-3">
                    <h6>取消原因：</h6>
                    <p class="text-muted">{{ order.cancel_reason }}</p>
                    <small class="text-muted">
                        申请人：{{ order.cancelled_by }}<br>
                        申请时间：{{ order.cancelled_at.strftime('%Y-%m-%d %H:%M:%S') if order.cancelled_at }}
                    </small>
                </div>
                {% endif %}

                <form method="POST" action="{{ url_for('admin.approve_cancel', order_id=order.id) }}" class="mb-2">
                    <button type="submit" class="btn btn-success w-100"
                            onclick="return confirm('确认批准取消这个订单吗？取消后无法恢复。')">
                        <i class="fas fa-check"></i> 批准取消
                    </button>
                </form>
                <form method="POST" action="{{ url_for('admin.reject_cancel', order_id=order.id) }}">
                    <button type="submit" class="btn btn-danger w-100"
                            onclick="return confirm('确认拒绝取消申请吗？订单将恢复为已确认状态。')">
                        <i class="fas fa-times"></i> 拒绝取消
                    </button>
                </form>
            </div>
        </div>
        {% elif order.status == 'cancelled' %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">订单已取消</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-dark">
                    <i class="fas fa-times-circle"></i>
                    该订单已被取消
                </div>

                {% if order.cancel_reason %}
                <div class="mb-3">
                    <h6>取消原因：</h6>
                    <p class="text-muted">{{ order.cancel_reason }}</p>
                    <small class="text-muted">
                        申请人：{{ order.cancelled_by }}<br>
                        {% if order.cancelled_at %}
                        申请时间：{{ order.cancelled_at.strftime('%Y-%m-%d %H:%M:%S') }}<br>
                        {% endif %}
                        {% if order.cancel_approved_by %}
                        审批人：{{ order.cancel_approved_by }}<br>
                        审批时间：{{ order.cancel_approved_at.strftime('%Y-%m-%d %H:%M:%S') }}
                        {% endif %}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
        {% elif order.refund_status == 'pending' %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">退款申请审批</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-exclamation-circle"></i>
                    用户申请退款，需要管理员审批
                </div>

                {% if order.refund_reason %}
                <div class="mb-3">
                    <h6>退款原因：</h6>
                    <p class="text-muted">{{ order.refund_reason }}</p>
                </div>
                {% endif %}

                {% if order.refund_qr_code %}
                <div class="mb-3">
                    <h6>收款二维码：</h6>
                    <img src="{{ url_for('static', filename='uploads/' + order.refund_qr_code) }}"
                         alt="收款二维码"
                         class="img-fluid"
                         style="max-width: 200px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                </div>
                {% endif %}

                <div class="mb-3">
                    <small class="text-muted">
                        申请时间：{{ order.refunded_at.strftime('%Y-%m-%d %H:%M:%S') if order.refunded_at }}
                    </small>
                </div>

                <!-- 审批表单 -->
                <form method="POST" action="{{ url_for('admin.approve_refund', order_id=order.id) }}" class="mb-2">
                    <div class="mb-3">
                        <label for="admin_notes_approve" class="form-label">管理员备注（可选）：</label>
                        <textarea class="form-control" id="admin_notes_approve" name="admin_notes" rows="2"
                                  placeholder="可以填写退款处理说明..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-success w-100"
                            onclick="return confirm('确认批准退款申请吗？批准后需要手动打款给用户。')">
                        <i class="fas fa-check"></i> 批准退款
                    </button>
                </form>

                <form method="POST" action="{{ url_for('admin.reject_refund', order_id=order.id) }}">
                    <div class="mb-3">
                        <label for="admin_notes_reject" class="form-label">拒绝原因 <span class="text-danger">*</span>：</label>
                        <textarea class="form-control" id="admin_notes_reject" name="admin_notes" rows="2"
                                  placeholder="请填写拒绝退款的原因..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-danger w-100"
                            onclick="return confirm('确认拒绝退款申请吗？')">
                        <i class="fas fa-times"></i> 拒绝退款
                    </button>
                </form>
            </div>
        </div>
        {% elif order.refund_status == 'approved' %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">退款已批准</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    退款申请已批准，请尽快打款给用户
                </div>

                {% if order.refund_qr_code %}
                <div class="mb-3">
                    <h6>用户收款二维码：</h6>
                    <img src="{{ url_for('static', filename='uploads/' + order.refund_qr_code) }}"
                         alt="收款二维码"
                         class="img-fluid"
                         style="max-width: 200px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                </div>
                {% endif %}

                <div class="mb-3">
                    <p><strong>退款金额：</strong> <span class="text-danger">¥{{ "%.2f"|format(order.total_amount) }}</span></p>
                    {% if order.refund_admin_notes %}
                    <p><strong>管理员备注：</strong> {{ order.refund_admin_notes }}</p>
                    {% endif %}
                    <small class="text-muted">
                        批准人：{{ order.refund_approved_by }}<br>
                        批准时间：{{ order.refund_approved_at.strftime('%Y-%m-%d %H:%M:%S') if order.refund_approved_at }}
                    </small>
                </div>

                <form method="POST" action="{{ url_for('admin.complete_refund', order_id=order.id) }}">
                    <button type="submit" class="btn btn-primary w-100"
                            onclick="return confirm('确认已完成打款吗？此操作将标记退款为完成状态。')">
                        <i class="fas fa-money-bill-wave"></i> 标记为已打款
                    </button>
                </form>
            </div>
        </div>
        {% elif order.refund_status == 'completed' %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">退款已完成</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-success">
                    <i class="fas fa-check-double"></i>
                    退款已完成
                </div>

                <div class="mb-3">
                    <p><strong>退款金额：</strong> <span class="text-success">¥{{ "%.2f"|format(order.total_amount) }}</span></p>
                    {% if order.refund_admin_notes %}
                    <p><strong>管理员备注：</strong> {{ order.refund_admin_notes }}</p>
                    {% endif %}
                    <small class="text-muted">
                        批准人：{{ order.refund_approved_by }}<br>
                        批准时间：{{ order.refund_approved_at.strftime('%Y-%m-%d %H:%M:%S') if order.refund_approved_at }}<br>
                        完成时间：{{ order.refund_completed_at.strftime('%Y-%m-%d %H:%M:%S') if order.refund_completed_at }}
                    </small>
                </div>
            </div>
        </div>
        {% elif order.refund_status == 'rejected' %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">退款已拒绝</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i>
                    退款申请已被拒绝
                </div>

                <div class="mb-3">
                    {% if order.refund_admin_notes %}
                    <p><strong>拒绝原因：</strong> {{ order.refund_admin_notes }}</p>
                    {% endif %}
                    <small class="text-muted">
                        处理人：{{ order.refund_approved_by }}<br>
                        处理时间：{{ order.refund_approved_at.strftime('%Y-%m-%d %H:%M:%S') if order.refund_approved_at }}
                    </small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const autoPrintCheckbox = document.getElementById('autoPrint');
    const printerSelection = document.getElementById('printerSelection');
    const confirmBtn = document.getElementById('confirmBtn');
    const confirmForm = document.getElementById('confirmForm');

    // 控制打印机选择的显示/隐藏
    function togglePrinterSelection() {
        if (autoPrintCheckbox && printerSelection) {
            if (autoPrintCheckbox.checked) {
                printerSelection.style.display = 'block';
                confirmBtn.innerHTML = '<i class="fas fa-check"></i> 确认订单并打印';
                confirmBtn.className = 'btn btn-success w-100';
            } else {
                printerSelection.style.display = 'none';
                confirmBtn.innerHTML = '<i class="fas fa-check"></i> 确认订单';
                confirmBtn.className = 'btn btn-primary w-100';
            }
        }
    }

    // 初始化显示状态
    togglePrinterSelection();

    // 监听复选框变化
    if (autoPrintCheckbox) {
        autoPrintCheckbox.addEventListener('change', togglePrinterSelection);
    }

    // 表单提交确认
    if (confirmForm) {
        confirmForm.addEventListener('submit', function(e) {
            const autoPrint = autoPrintCheckbox.checked;
            const selectedPrinter = document.getElementById('printerSelect').value;
            const printerName = selectedPrinter ?
                document.getElementById('printerSelect').options[document.getElementById('printerSelect').selectedIndex].text :
                '默认打印机';

            let confirmMessage = '确认要确认这个订单吗？';

            if (autoPrint) {
                confirmMessage = `确认要确认这个订单并发送到 ${printerName} 打印吗？`;
            }

            if (!confirm(confirmMessage)) {
                e.preventDefault();
                return false;
            }
        });
    }
});
</script>
{% endblock %}
