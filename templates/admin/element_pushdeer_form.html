{% extends "admin/element_base.html" %}

{% block title %}{{ action }}æ¨é€é…ç½® - å‘è´¢å°ç‹—é¥®å“åº—{% endblock %}
{% block active_menu %}pushdeer{% endblock %}

{% block page_icon %}<i class="fas fa-bell"></i>{% endblock %}
{% block page_title %}{{ action }}æ¨é€é…ç½®{% endblock %}

{% block page_actions %}
<el-button @click="goBack">
    <i class="fas fa-arrow-left"></i> è¿”å›åˆ—è¡¨
</el-button>
{% endblock %}

{% block content %}
<div class="form-container">
    <el-row :gutter="20">
        <el-col :lg="16" :md="24">
            <el-card>
                <div slot="header" class="clearfix">
                    <span style="font-weight: 600;">
                        <i class="fas fa-edit"></i> {{ action }}æ¨é€é…ç½®
                    </span>
                </div>
                
                <el-form 
                    :model="configForm" 
                    :rules="formRules" 
                    ref="configForm" 
                    label-width="120px"
                    @submit.native.prevent="submitForm">
                    
                    <el-form-item label="é…ç½®åç§°" prop="name">
                        <el-input 
                            v-model="configForm.name" 
                            placeholder="è¯·è¾“å…¥é…ç½®åç§°ï¼Œå¦‚ï¼šç®¡ç†å‘˜é€šçŸ¥"
                            maxlength="100"
                            show-word-limit>
                        </el-input>
                    </el-form-item>
                    
                    <el-form-item label="PushKey" prop="pushkey">
                        <el-input 
                            v-model="configForm.pushkey" 
                            placeholder="è¯·è¾“å…¥PushDeerçš„PushKey"
                            maxlength="200"
                            show-word-limit>
                            <template slot="prepend">
                                <i class="fas fa-key"></i>
                            </template>
                        </el-input>
                        <div class="form-tip">
                            <i class="fas fa-info-circle"></i>
                            åœ¨ <a href="https://pushdeer.com" target="_blank">PushDeerå®˜ç½‘</a> æ³¨å†Œè´¦å·åè·å–PushKey
                        </div>
                    </el-form-item>
                    
                    <el-form-item label="æ¨é€ç«¯ç‚¹" prop="endpoint">
                        <el-input 
                            v-model="configForm.endpoint" 
                            placeholder="æ¨é€APIç«¯ç‚¹åœ°å€">
                            <template slot="prepend">
                                <i class="fas fa-link"></i>
                            </template>
                        </el-input>
                        <div class="form-tip">
                            <i class="fas fa-info-circle"></i>
                            é»˜è®¤ä½¿ç”¨å®˜æ–¹APIï¼šhttps://api2.pushdeer.com/message/push
                        </div>
                    </el-form-item>
                    
                    <el-form-item label="é…ç½®æè¿°">
                        <el-input
                            v-model="configForm.description"
                            type="textarea"
                            :rows="3"
                            placeholder="è¯·è¾“å…¥é…ç½®æè¿°ï¼Œå¦‚ï¼šç”¨äºæ¥æ”¶æ–°è®¢å•é€šçŸ¥"
                            maxlength="500"
                            show-word-limit>
                        </el-input>
                    </el-form-item>
                    
                    <el-form-item label="æ¨é€äº‹ä»¶">
                        <el-checkbox-group v-model="configForm.events">
                            <el-checkbox label="new_order">æ–°è®¢å•</el-checkbox>
                            <el-checkbox label="order_confirmed">è®¢å•ç¡®è®¤</el-checkbox>
                            <el-checkbox label="order_completed">è®¢å•å®Œæˆ</el-checkbox>
                            <el-checkbox label="order_cancelled">è®¢å•å–æ¶ˆ</el-checkbox>
                            <el-checkbox label="payment_received">æ”¶åˆ°ä»˜æ¬¾</el-checkbox>
                            <el-checkbox label="refund_request">é€€æ¬¾ç”³è¯·</el-checkbox>
                        </el-checkbox-group>
                        <div class="form-tip">
                            <i class="fas fa-info-circle"></i>
                            é€‰æ‹©éœ€è¦æ¨é€é€šçŸ¥çš„äº‹ä»¶ç±»å‹
                        </div>
                    </el-form-item>
                    
                    <el-form-item label="é…ç½®çŠ¶æ€">
                        <el-switch
                            v-model="configForm.is_active"
                            active-text="å¯ç”¨"
                            inactive-text="ç¦ç”¨">
                        </el-switch>
                        <span style="margin-left: 10px; color: #606266;">
                            ç¦ç”¨åå°†ä¸ä¼šå‘é€æ¨é€é€šçŸ¥
                        </span>
                    </el-form-item>
                    
                    <el-form-item>
                        <el-button 
                            type="primary" 
                            @click="submitForm" 
                            :loading="submitting"
                            size="large">
                            <i class="fas fa-save"></i> {{ action }}é…ç½®
                        </el-button>
                        <el-button 
                            type="success" 
                            @click="testPush" 
                            :loading="testing"
                            size="large"
                            v-if="configForm.pushkey">
                            <i class="fas fa-paper-plane"></i> æµ‹è¯•æ¨é€
                        </el-button>
                        <el-button @click="goBack" size="large">
                            <i class="fas fa-times"></i> å–æ¶ˆ
                        </el-button>
                    </el-form-item>
                </el-form>
            </el-card>
        </el-col>
        
        <el-col :lg="8" :md="24">
            <!-- é…ç½®è¯´æ˜ -->
            <el-card>
                <div slot="header" class="clearfix">
                    <span style="font-weight: 600;">
                        <i class="fas fa-question-circle"></i> é…ç½®è¯´æ˜
                    </span>
                </div>
                
                <div class="config-help">
                    <h4>å¦‚ä½•è·å–PushKeyï¼Ÿ</h4>
                    <ol>
                        <li>è®¿é—® <a href="https://pushdeer.com" target="_blank">PushDeerå®˜ç½‘</a></li>
                        <li>æ³¨å†Œè´¦å·å¹¶ç™»å½•</li>
                        <li>åœ¨æ§åˆ¶å°åˆ›å»ºåº”ç”¨</li>
                        <li>å¤åˆ¶ç”Ÿæˆçš„PushKey</li>
                        <li>ç²˜è´´åˆ°ä¸Šæ–¹è¾“å…¥æ¡†ä¸­</li>
                    </ol>
                    
                    <h4>æ¨é€äº‹ä»¶è¯´æ˜</h4>
                    <ul>
                        <li><strong>æ–°è®¢å•ï¼š</strong>ç”¨æˆ·ä¸‹å•æ—¶æ¨é€</li>
                        <li><strong>è®¢å•ç¡®è®¤ï¼š</strong>ç®¡ç†å‘˜ç¡®è®¤è®¢å•æ—¶æ¨é€</li>
                        <li><strong>è®¢å•å®Œæˆï¼š</strong>è®¢å•å®Œæˆæ—¶æ¨é€</li>
                        <li><strong>è®¢å•å–æ¶ˆï¼š</strong>è®¢å•è¢«å–æ¶ˆæ—¶æ¨é€</li>
                        <li><strong>æ”¶åˆ°ä»˜æ¬¾ï¼š</strong>æ”¶åˆ°ä»˜æ¬¾æ—¶æ¨é€</li>
                        <li><strong>é€€æ¬¾ç”³è¯·ï¼š</strong>ç”¨æˆ·ç”³è¯·é€€æ¬¾æ—¶æ¨é€</li>
                    </ul>
                    
                    <h4>æ³¨æ„äº‹é¡¹</h4>
                    <ul>
                        <li>PushKeyè¯·å¦¥å–„ä¿ç®¡ï¼Œä¸è¦æ³„éœ²</li>
                        <li>å»ºè®®å…ˆæµ‹è¯•æ¨é€ç¡®ä¿é…ç½®æ­£ç¡®</li>
                        <li>å¯ä»¥åˆ›å»ºå¤šä¸ªé…ç½®ç”¨äºä¸åŒåœºæ™¯</li>
                        <li>ç¦ç”¨çš„é…ç½®ä¸ä¼šå‘é€æ¨é€</li>
                    </ul>
                </div>
            </el-card>
            
            <!-- æ¨é€é¢„è§ˆ -->
            <el-card style="margin-top: 20px;">
                <div slot="header" class="clearfix">
                    <span style="font-weight: 600;">
                        <i class="fas fa-eye"></i> æ¨é€é¢„è§ˆ
                    </span>
                </div>
                
                <div class="push-preview">
                    <div class="preview-item">
                        <div class="preview-title">ğŸ†• æ–°è®¢å•é€šçŸ¥</div>
                        <div class="preview-content">
                            è®¢å• #12345 å·²æäº¤<br>
                            å®¢æˆ·ï¼šå¼ ä¸‰<br>
                            é‡‘é¢ï¼šÂ¥25.80<br>
                            æ—¶é—´ï¼š{{ "{{ new Date().toLocaleString() }}" }}
                        </div>
                    </div>
                    
                    <div class="preview-item">
                        <div class="preview-title">âœ… è®¢å•ç¡®è®¤é€šçŸ¥</div>
                        <div class="preview-content">
                            è®¢å• #12345 å·²ç¡®è®¤<br>
                            é¢„è®¡å®Œæˆæ—¶é—´ï¼š15åˆ†é’Ÿ<br>
                            è¯·åŠæ—¶åˆ¶ä½œé¥®å“
                        </div>
                    </div>
                </div>
            </el-card>
        </el-col>
    </el-row>
</div>
{% endblock %}

{% block extra_css %}
<style>
.form-container {
    max-width: 1200px;
    margin: 0 auto;
}

.form-tip {
    margin-top: 5px;
    color: #909399;
    font-size: 12px;
    display: flex;
    align-items: center;
}

.form-tip i {
    margin-right: 5px;
}

.form-tip a {
    color: #409EFF;
    text-decoration: none;
}

.form-tip a:hover {
    text-decoration: underline;
}

.config-help {
    font-size: 14px;
    line-height: 1.6;
}

.config-help h4 {
    color: #303133;
    margin: 15px 0 10px 0;
    font-size: 14px;
}

.config-help h4:first-child {
    margin-top: 0;
}

.config-help ol, .config-help ul {
    margin: 0 0 15px 0;
    padding-left: 20px;
}

.config-help li {
    margin-bottom: 5px;
    color: #606266;
}

.config-help a {
    color: #409EFF;
    text-decoration: none;
}

.config-help a:hover {
    text-decoration: underline;
}

.push-preview {
    font-size: 14px;
}

.preview-item {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    border-left: 4px solid #409EFF;
}

.preview-item:last-child {
    margin-bottom: 0;
}

.preview-title {
    font-weight: 600;
    color: #303133;
    margin-bottom: 8px;
}

.preview-content {
    color: #606266;
    line-height: 1.5;
}
</style>
{% endblock %}

{% block vue_data %}
configForm: {
    name: {{ (config.name if config else "")|tojson }},
    pushkey: {{ (config.pushkey if config else "")|tojson }},
    endpoint: {{ (config.endpoint if config else "https://api2.pushdeer.com/message/push")|tojson }},
    description: {{ (config.description if config else "")|tojson }},
    events: {{ (config.events.split(',') if config and config.events else ["new_order", "order_confirmed"])|tojson }},
    is_active: {{ 'true' if config and config.is_active else 'true' }}
},
submitting: false,
testing: false,
formRules: {
    name: [
        { required: true, message: 'è¯·è¾“å…¥é…ç½®åç§°', trigger: 'blur' },
        { min: 1, max: 100, message: 'é…ç½®åç§°é•¿åº¦åœ¨ 1 åˆ° 100 ä¸ªå­—ç¬¦', trigger: 'blur' }
    ],
    pushkey: [
        { required: true, message: 'è¯·è¾“å…¥PushKey', trigger: 'blur' },
        { min: 10, max: 200, message: 'PushKeyé•¿åº¦åœ¨ 10 åˆ° 200 ä¸ªå­—ç¬¦', trigger: 'blur' }
    ],
    endpoint: [
        { required: true, message: 'è¯·è¾“å…¥æ¨é€ç«¯ç‚¹', trigger: 'blur' },
        { type: 'url', message: 'è¯·è¾“å…¥æ­£ç¡®çš„URLæ ¼å¼', trigger: 'blur' }
    ]
}
{% endblock %}

{% block vue_methods %}
submitForm() {
    this.$refs.configForm.validate((valid) => {
        if (valid) {
            this.submitting = true;
            
            const formData = new FormData();
            Object.keys(this.configForm).forEach(key => {
                if (key === 'events') {
                    formData.append(key, this.configForm[key].join(','));
                } else {
                    formData.append(key, this.configForm[key]);
                }
            });
            
            const url = {{ ('"/admin/pushdeer/" + config.id|string + "/edit"' if config else '"/admin/pushdeer/add"')|safe }};
            
            fetch(url, {
                method: 'POST',
                body: formData
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.$message.success('{{ action }}é…ç½®æˆåŠŸï¼');
                    setTimeout(() => {
                        window.location.href = '/admin/pushdeer';
                    }, 1000);
                } else {
                    this.$message.error(data.message || '{{ action }}é…ç½®å¤±è´¥');
                }
            }).catch(error => {
                this.$message.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }).finally(() => {
                this.submitting = false;
            });
        }
    });
},

async testPush() {
    if (!this.configForm.pushkey) {
        this.$message.warning('è¯·å…ˆè¾“å…¥PushKey');
        return;
    }
    
    this.testing = true;
    
    try {
        const response = await fetch('/admin/pushdeer/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                pushkey: this.configForm.pushkey,
                endpoint: this.configForm.endpoint
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            this.$message.success('æµ‹è¯•æ¨é€å‘é€æˆåŠŸï¼è¯·æ£€æŸ¥æ‚¨çš„è®¾å¤‡');
        } else {
            this.$message.error(result.message || 'æµ‹è¯•æ¨é€å¤±è´¥');
        }
    } catch (error) {
        this.$message.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
    } finally {
        this.testing = false;
    }
},

goBack() {
    window.location.href = '/admin/pushdeer';
}
{% endblock %}
