{% extends "base.html" %}

{% block title %}ç”³è¯·é€€æ¬¾ - å‘è´¢å°ç‹—é¥®å“åº—{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
    }

    .refund-container {
        max-width: 1200px;
        margin: 20px auto;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        padding: 0 20px;
    }

    .left-panel, .right-panel {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        overflow: hidden;
    }

    .refund-header {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }

    .refund-header h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 600;
    }

    .refund-header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
        font-size: 16px;
    }

    .refund-content {
        padding: 40px;
    }

    .order-info {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        border-left: 5px solid #ff6b6b;
    }

    .order-info h3 {
        margin: 0 0 15px 0;
        color: #2c3e50;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .order-detail {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .detail-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }

    .detail-label {
        font-weight: 600;
        color: #666;
    }

    .detail-value {
        color: #2c3e50;
        font-weight: 500;
    }

    .refund-form {
        background: #fff;
        border-radius: 15px;
        padding: 30px;
        border: 2px solid #f1f2f6;
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
        font-size: 16px;
    }

    .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s ease;
        box-sizing: border-box;
    }

    .form-control:focus {
        outline: none;
        border-color: #ff6b6b;
        box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
    }

    .form-textarea {
        min-height: 120px;
        resize: vertical;
        font-family: inherit;
    }

    .char-count {
        text-align: right;
        font-size: 12px;
        color: #666;
        margin-top: 5px;
    }

    .upload-section {
        background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
        border: 2px dashed #ff6b6b;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        margin: 25px 0;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }

    .upload-section:hover {
        border-color: #ff5252;
        background: linear-gradient(135deg, #fff0f0 0%, #ffd0d0 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.2);
    }

    .upload-section.dragover {
        border-color: #4CAF50;
        background: linear-gradient(135deg, #f0fff0 0%, #d0ffd0 100%);
        transform: scale(1.02);
    }

    .upload-icon {
        font-size: 48px;
        color: #ff6b6b;
        margin-bottom: 15px;
        animation: float 3s ease-in-out infinite;
    }

    .upload-text {
        font-size: 18px;
        font-weight: 600;
        color: #ff6b6b;
        margin-bottom: 10px;
    }

    .upload-hint {
        color: #666;
        font-size: 14px;
        line-height: 1.5;
    }

    .file-input {
        display: none;
    }

    .preview-area {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        display: none;
    }

    .preview-image {
        max-width: 100%;
        max-height: 200px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 15px;
    }

    .file-info {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #4CAF50;
    }

    .file-actions {
        margin-top: 15px;
        text-align: center;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        margin: 0 5px;
    }

    .btn-primary {
        background: #ff6b6b;
        color: white;
    }

    .btn-primary:hover {
        background: #ff5252;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-success:hover {
        background: #218838;
        transform: translateY(-2px);
    }

    .alert {
        padding: 15px 20px;
        border-radius: 10px;
        margin: 15px 0;
        font-weight: 500;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .alert-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .policy-section {
        background: #e3f2fd;
        border-radius: 15px;
        padding: 25px;
        margin: 25px 0;
        border-left: 5px solid #2196F3;
    }

    .policy-section h4 {
        margin: 0 0 15px 0;
        color: #1976D2;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .policy-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .policy-list li {
        padding: 8px 0;
        color: #424242;
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }

    .policy-list li:before {
        content: "âœ“";
        color: #4CAF50;
        font-weight: bold;
        flex-shrink: 0;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }

    /* å¯è§†åŒ–åˆ†åŒºæ ·å¼ */
    .section-divider {
        height: 3px;
        background: linear-gradient(90deg, #ff6b6b 0%, #4facfe 50%, #28a745 100%);
        margin: 20px 0;
        border-radius: 2px;
    }

    .step-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 20px 0;
        gap: 15px;
    }

    .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        position: relative;
    }

    .step.active {
        background: #ff6b6b;
        box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
    }

    .step.completed {
        background: #28a745;
    }

    .step.pending {
        background: #ddd;
        color: #999;
    }

    .step-line {
        width: 50px;
        height: 3px;
        background: #ddd;
        border-radius: 2px;
    }

    .step-line.active {
        background: #ff6b6b;
    }

    /* å¡ç‰‡æ‚¬æµ®æ•ˆæœ */
    .left-panel, .right-panel {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .left-panel:hover, .right-panel:hover {
        transform: translateY(-5px);
        box-shadow: 0 25px 70px rgba(0,0,0,0.2);
    }

    /* ç§»åŠ¨ç«¯å“åº”å¼è®¾è®¡ */
    @media (max-width: 1024px) {
        .refund-container {
            grid-template-columns: 1fr;
            max-width: 800px;
            gap: 15px;
        }

        .left-panel, .right-panel {
            margin: 0;
        }
    }

    @media (max-width: 768px) {
        .refund-container {
            margin: 10px;
            padding: 0 10px;
        }

        .refund-content {
            padding: 20px;
        }

        .order-detail {
            grid-template-columns: 1fr;
        }

        .refund-header h1, .refund-header h2 {
            font-size: 20px;
        }

        .step-indicator {
            gap: 10px;
        }

        .step {
            width: 35px;
            height: 35px;
            font-size: 14px;
        }

        .step-line {
            width: 30px;
            height: 2px;
        }
    }

    @media (max-width: 480px) {
        .refund-header {
            padding: 20px;
        }

        .refund-header h1, .refund-header h2 {
            font-size: 18px;
        }

        .btn {
            padding: 10px 16px;
            font-size: 14px;
            margin: 5px;
            display: block;
            width: calc(100% - 10px);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- é¡µé¢æ ‡é¢˜ -->
<div style="text-align: center; margin: 20px 0; color: white;">
    <h1 style="font-size: 32px; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
        <i class="fas fa-undo-alt"></i> ç”³è¯·é€€æ¬¾
    </h1>
    <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 18px;">å‘è´¢å°ç‹—é¥®å“åº— - æˆ‘ä»¬é‡è§†æ¯ä¸€ä½å®¢æˆ·çš„ä½“éªŒ</p>
</div>

<div class="refund-container">
    <!-- å·¦ä¾§é¢æ¿ï¼šè®¢å•ä¿¡æ¯å’Œæ”¿ç­– -->
    <div class="left-panel">
        <!-- è®¢å•ä¿¡æ¯åŒºåŸŸ -->
        <div class="refund-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <h2 style="margin: 0; font-size: 24px;"><i class="fas fa-receipt"></i> è®¢å•è¯¦æƒ…</h2>
            <p style="margin: 8px 0 0 0; opacity: 0.9;">è®¢å• #{{ order.id }}</p>
        </div>

        <div class="refund-content">
            <div class="order-info" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 5px solid #4facfe;">
                <div class="order-detail">
                    <div class="detail-item">
                        <span class="detail-label"><i class="fas fa-hashtag"></i> è®¢å•å·:</span>
                        <span class="detail-value">#{{ order.id }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label"><i class="fas fa-info-circle"></i> è®¢å•çŠ¶æ€:</span>
                        <span class="detail-value" style="color: {% if order.status == 'paid' %}#28a745{% elif order.status == 'pending' %}#ffc107{% else %}#6c757d{% endif %};">
                            {{ order.status_display }}
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label"><i class="fas fa-money-bill-wave"></i> è®¢å•é‡‘é¢:</span>
                        <span class="detail-value" style="color: #e74c3c; font-weight: bold; font-size: 18px;">Â¥{{ "%.2f"|format(order.total_amount) }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label"><i class="fas fa-clock"></i> ä¸‹å•æ—¶é—´:</span>
                        <span class="detail-value">{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    </div>
                </div>
            </div>

            <!-- è®¢å•å•†å“åˆ—è¡¨ -->
            <div style="margin-top: 25px;">
                <h4 style="color: #2c3e50; margin-bottom: 15px;"><i class="fas fa-shopping-cart"></i> å•†å“æ¸…å•</h4>
                <div style="background: #fff; border-radius: 10px; border: 1px solid #e9ecef;">
                    {% for item in order.items %}
                    <div style="padding: 15px; border-bottom: 1px solid #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: #2c3e50;">{{ item.drink_product.name }}</div>
                            <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                                {% if item.size %}{{ item.size }}{% endif %}
                                {% if item.temperature %} | {{ item.temperature }}{% endif %}
                                {% if item.sugar_level %} | {{ item.sugar_level }}{% endif %}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: #e74c3c;">Â¥{{ "%.2f"|format(item.subtotal) }}</div>
                            <div style="font-size: 12px; color: #6c757d;">x{{ item.quantity }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- é€€æ¬¾æ”¿ç­– -->
            <div class="policy-section" style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); border-left: 5px solid #28a745;">
                <h4 style="color: #155724;"><i class="fas fa-shield-alt"></i> é€€æ¬¾æ”¿ç­–</h4>
                <ul class="policy-list">
                    {% if order.needs_refund_approval %}
                    <li>å·²ä»˜æ¬¾è®¢å•éœ€è¦ç®¡ç†å‘˜å®¡æ‰¹é€€æ¬¾ç”³è¯·</li>
                    <li>è¯·ä¸Šä¼ æ‚¨çš„æ”¶æ¬¾äºŒç»´ç ï¼Œæˆ‘ä»¬å°†é€šè¿‡æ‰«ç è½¬è´¦é€€æ¬¾</li>
                    <li>é€€æ¬¾ç”³è¯·æäº¤åï¼Œæˆ‘ä»¬ä¼šåœ¨24å°æ—¶å†…å¤„ç†</li>
                    <li>é€€æ¬¾æˆåŠŸåï¼Œæ‚¨å°†æ”¶åˆ°ç¡®è®¤é€šçŸ¥</li>
                    {% else %}
                    <li>å¾…ç¡®è®¤è®¢å•å¯ä»¥ç«‹å³é€€æ¬¾</li>
                    <li>é€€æ¬¾åè®¢å•çŠ¶æ€å°†å˜ä¸º"å·²å–æ¶ˆ"</li>
                    <li>å¦‚æœ‰ç–‘é—®è¯·è”ç³»å®¢æœ</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>

    <!-- å³ä¾§é¢æ¿ï¼šé€€æ¬¾ç”³è¯·è¡¨å• -->
    <div class="right-panel">
        <div class="refund-header" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
            <h2 style="margin: 0; font-size: 24px;"><i class="fas fa-edit"></i> é€€æ¬¾ç”³è¯·</h2>
            <p style="margin: 8px 0 0 0; opacity: 0.9;">è¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯</p>
        </div>

        <div class="refund-content">

            <!-- é€€æ¬¾è¡¨å• -->
            <form method="POST" enctype="multipart/form-data" id="refundForm" class="refund-form" style="border: none; padding: 30px;">
                <!-- å¯è§†åŒ–æ­¥éª¤æŒ‡ç¤ºå™¨ -->
                <div class="step-indicator">
                    <div class="step active" title="å¡«å†™é€€æ¬¾åŸå› ">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="step-line {% if order.needs_refund_approval %}active{% endif %}"></div>
                    {% if order.needs_refund_approval %}
                    <div class="step active" title="ä¸Šä¼ æ”¶æ¬¾äºŒç»´ç ">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <div class="step-line"></div>
                    {% endif %}
                    <div class="step pending" title="å®Œæˆç”³è¯·">
                        <i class="fas fa-check"></i>
                    </div>
                </div>

                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; font-size: 14px;">
                        {% if order.needs_refund_approval %}
                        <i class="fas fa-info-circle"></i> å·²ä»˜æ¬¾è®¢å•éœ€è¦ä¸Šä¼ æ”¶æ¬¾äºŒç»´ç å¹¶ç­‰å¾…å®¡æ‰¹
                        {% else %}
                        <i class="fas fa-bolt"></i> å¾…ç¡®è®¤è®¢å•å¯ä»¥ç«‹å³é€€æ¬¾
                        {% endif %}
                    </div>
                </div>

                <!-- åˆ†åŒºåˆ†éš”çº¿ -->
                <div class="section-divider"></div>
            
            <!-- é€€æ¬¾åŸå›  -->
            <div class="form-group">
                <label for="refund_reason" class="form-label">
                    <i class="fas fa-comment-alt"></i> é€€æ¬¾åŸå›  <span style="color: #e74c3c;">*</span>
                </label>
                <textarea 
                    id="refund_reason" 
                    name="refund_reason" 
                    class="form-control form-textarea" 
                    placeholder="è¯·è¯¦ç»†è¯´æ˜é€€æ¬¾åŸå› ï¼Œè¿™å°†å¸®åŠ©æˆ‘ä»¬æ”¹è¿›æœåŠ¡è´¨é‡..."
                    required
                    maxlength="500"></textarea>
                <div class="char-count" id="charCount">0/500 å­—ç¬¦</div>
            </div>

            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸï¼ˆä»…å·²ä»˜æ¬¾è®¢å•éœ€è¦ï¼‰ -->
            {% if order.needs_refund_approval %}
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-qrcode"></i> æ”¶æ¬¾äºŒç»´ç  <span style="color: #e74c3c;">*</span>
                </label>
                <div class="upload-section" id="uploadArea">
                    <div class="upload-icon">ğŸ“±</div>
                    <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ”¶æ¬¾äºŒç»´ç </div>
                    <div class="upload-hint">
                        æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 5MB<br>
                        è¯·ä¸Šä¼ æ‚¨çš„å¾®ä¿¡æˆ–æ”¯ä»˜å®æ”¶æ¬¾äºŒç»´ç 
                    </div>
                </div>
                <input type="file" id="fileInput" name="refund_qr_code" class="file-input" accept="image/*" required>
                
                <div class="preview-area" id="previewArea">
                    <img id="previewImage" class="preview-image" alt="äºŒç»´ç é¢„è§ˆ">
                    <div class="file-info" id="fileInfo"></div>
                    <div class="file-actions">
                        <button type="button" class="btn btn-secondary" onclick="clearFile()">
                            <i class="fas fa-trash"></i> é‡æ–°é€‰æ‹©
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- æäº¤æŒ‰é’® -->
            <div style="text-align: center; margin-top: 30px;">
                {% if order.needs_refund_approval %}
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="fas fa-paper-plane"></i> æäº¤é€€æ¬¾ç”³è¯·
                </button>
                {% else %}
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="fas fa-undo"></i> ç«‹å³é€€æ¬¾
                </button>
                {% endif %}
                <a href="{{ url_for('main.order_detail', order_id=order.id) }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> è¿”å›è®¢å•
                </a>
            </div>
            </form>
        </div>
    </div>
</div>

<div id="messageArea"></div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // è·å–DOMå…ƒç´ 
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const previewArea = document.getElementById('previewArea');
    const previewImage = document.getElementById('previewImage');
    const fileInfo = document.getElementById('fileInfo');
    const messageArea = document.getElementById('messageArea');
    const refundReason = document.getElementById('refund_reason');
    const charCount = document.getElementById('charCount');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('refundForm');

    let selectedFile = null;

    // å­—ç¬¦è®¡æ•°
    if (refundReason && charCount) {
        refundReason.addEventListener('input', function() {
            const length = this.value.length;
            charCount.textContent = `${length}/500 å­—ç¬¦`;

            if (length < 10) {
                charCount.style.color = '#e74c3c';
            } else if (length > 450) {
                charCount.style.color = '#f39c12';
            } else {
                charCount.style.color = '#27ae60';
            }
        });
    }

    // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼ˆä»…åœ¨éœ€è¦æ—¶åˆå§‹åŒ–ï¼‰
    if (uploadArea && fileInput) {
        // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        });

        // æ‹–æ‹½äº‹ä»¶
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            if (!uploadArea.contains(e.relatedTarget)) {
                uploadArea.classList.remove('dragover');
            }
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
    }

    // å¤„ç†æ–‡ä»¶
    function handleFile(file) {
        console.log('å¤„ç†æ–‡ä»¶:', file);

        // éªŒè¯æ–‡ä»¶ç±»å‹
        if (!file.type.startsWith('image/')) {
            showMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼ˆJPGã€PNGã€GIFæ ¼å¼ï¼‰', 'error');
            return;
        }

        // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ5MBï¼‰
        if (file.size > 5 * 1024 * 1024) {
            showMessage('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MBï¼Œè¯·é€‰æ‹©æ›´å°çš„å›¾ç‰‡', 'error');
            return;
        }

        selectedFile = file;

        // æ˜¾ç¤ºé¢„è§ˆ
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImage.src = e.target.result;
            previewArea.style.display = 'block';
            uploadArea.style.display = 'none';

            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            fileInfo.innerHTML = `
                <div style="margin-bottom: 10px;"><strong>æ–‡ä»¶å:</strong> ${file.name}</div>
                <div style="margin-bottom: 10px;"><strong>æ–‡ä»¶å¤§å°:</strong> ${formatFileSize(file.size)}</div>
                <div><strong>æ–‡ä»¶ç±»å‹:</strong> ${file.type}</div>
            `;

            showMessage('æ”¶æ¬¾äºŒç»´ç ä¸Šä¼ æˆåŠŸï¼', 'success');
        };

        reader.readAsDataURL(file);
    }

    // æ¸…é™¤æ–‡ä»¶
    window.clearFile = function() {
        selectedFile = null;
        fileInput.value = '';
        previewArea.style.display = 'none';
        uploadArea.style.display = 'block';
        showMessage('æ–‡ä»¶å·²æ¸…é™¤ï¼Œè¯·é‡æ–°é€‰æ‹©', 'warning');
    };

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(message, type) {
        const alertClass = type === 'error' ? 'alert-danger' :
                          type === 'warning' ? 'alert-warning' : 'alert-success';

        messageArea.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;

        // æ»šåŠ¨åˆ°æ¶ˆæ¯åŒºåŸŸ
        messageArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        // 3ç§’åè‡ªåŠ¨æ¸…é™¤
        setTimeout(() => {
            messageArea.innerHTML = '';
        }, 3000);
    }

    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // è¡¨å•æäº¤
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // éªŒè¯é€€æ¬¾åŸå› 
        const reason = refundReason.value.trim();
        if (reason.length < 10) {
            showMessage('è¯·å¡«å†™è‡³å°‘10ä¸ªå­—ç¬¦çš„é€€æ¬¾åŸå› ', 'error');
            refundReason.focus();
            return;
        }

        // éªŒè¯æ–‡ä»¶ä¸Šä¼ ï¼ˆå¦‚æœéœ€è¦ï¼‰
        const needsFile = {{ 'true' if order.needs_refund_approval else 'false' }};
        if (needsFile && !selectedFile) {
            showMessage('è¯·ä¸Šä¼ æ‚¨çš„æ”¶æ¬¾äºŒç»´ç ', 'error');
            return;
        }

        // ç¡®è®¤æäº¤
        const isApproval = {{ 'true' if order.needs_refund_approval else 'false' }};
        const title = isApproval ? 'ç¡®è®¤æäº¤é€€æ¬¾ç”³è¯·ï¼Ÿ' : 'ç¡®è®¤ç«‹å³é€€æ¬¾ï¼Ÿ';
        const text = isApproval ?
            'æˆ‘ä»¬ä¼šåœ¨æ”¶åˆ°ç”³è¯·åå°½å¿«å®¡æ ¸ï¼Œå®¡æ ¸é€šè¿‡åå°†é€šè¿‡æ‚¨ä¸Šä¼ çš„äºŒç»´ç è½¬è´¦é€€æ¬¾ã€‚' :
            'é€€æ¬¾å°†ç«‹å³ç”Ÿæ•ˆï¼Œè®¢å•çŠ¶æ€å°†å˜ä¸ºå·²å–æ¶ˆã€‚';

        Swal.fire({
            title: title,
            text: text,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#ff6b6b',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'ç¡®è®¤æäº¤',
            cancelButtonText: 'å–æ¶ˆ'
        }).then((result) => {
            if (result.isConfirmed) {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¤„ç†ä¸­...';
                submitBtn.disabled = true;

                // æäº¤è¡¨å•
                form.submit();
            }
        });
    });

    // é¡µé¢åŠ è½½å®Œæˆæç¤º
    showMessage('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·å¡«å†™é€€æ¬¾ä¿¡æ¯', 'success');
});
</script>
{% endblock %}
